# Документация по аутентификации и авторизации

## Содержание
1. [Обзор системы](#обзор-системы)
2. [Методы аутентификации](#методы-аутентификации)
3. [Процесс регистрации](#процесс-регистрации)
4. [Процесс входа в систему](#процесс-входа-в-систему)
5. [Обновление токенов](#обновление-токенов)
6. [Выход из системы](#выход-из-системы)
7. [GitHub OAuth](#github-oauth)
8. [Управление сессиями](#управление-сессиями)
9. [Ролевая модель и права доступа](#ролевая-модель-и-права-доступа)
10. [Ошибки аутентификации](#ошибки-аутентификации)

## Обзор системы

Система аутентификации использует JWT (JSON Web Tokens) для защиты API. Поддерживаются два типа токенов:

- **Access Token**: Короткоживущий токен (30 минут) для доступа к защищенным ресурсам
- **Refresh Token**: Долгоживущий токен (7 дней) для обновления access token

Все refresh tokens хранятся в базе данных с информацией о user agent для отслеживания активных сессий.

## Методы аутентификации

### 1. Email и пароль
Традиционная регистрация и вход с использованием email и пароля.

### 2. GitHub OAuth
Аутентификация через аккаунт GitHub. Пользователь перенаправляется на GitHub для авторизации, затем возвращается на сайт с токенами.

## Процесс регистрации

### Запрос
**Endpoint**: `POST /auth/register`

**Тело запроса**:
```json
{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "password123",
  "avatar": "http://example.com/avatar.jpg" // опционально
}
```

### Успешный ответ
**Status**: `200 OK`

**Тело ответа**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### Ожидаемый результат
- Создается новый пользователь в базе данных
- Пароль хешируется с использованием Argon2
- Генерируются access и refresh токены
- Refresh token сохраняется в базе данных с user agent
- Пользователь автоматически входит в систему

### Ошибки
- **400 Bad Request**: Если email уже зарегистрирован
```json
{
  "detail": "Email already registered"
}
```

- **400 Bad Request**: При других ошибках валидации
```json
{
  "detail": "Registration failed: [описание ошибки]"
}
```

## Процесс входа в систему

### Запрос
**Endpoint**: `POST /auth/login`

**Тело запроса**:
```json
{
  "email": "john@example.com",
  "password": "password123"
}
```

### Успешный ответ
**Status**: `200 OK`

**Тело ответа**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### Ожидаемый результат
- Проверяется email и пароль
- Генерируются новые access и refresh токены
- Старый refresh token заменяется новым
- Пользователь получает доступ к системе

### Ошибки
- **401 Unauthorized**: Неверный email или пароль
```json
{
  "detail": "Incorrect email or password"
}
```

- **400 Bad Request**: Другие ошибки аутентификации
```json
{
  "detail": "Login failed: [описание ошибки]"
}
```

## Обновление токенов

### Запрос
**Endpoint**: `POST /auth/refresh`

**Тело запроса**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Успешный ответ
**Status**: `200 OK`

**Тело ответа**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### Ожидаемый результат
- Проверяется валидность refresh token
- Создаются новые access и refresh токены
- Старый refresh token заменяется новым в базе данных
- User agent обновляется

### Ошибки
- **401 Unauthorized**: Неверный или просроченный refresh token
```json
{
  "detail": "Refresh token expired or invalid"
}
```

- **401 Unauthorized**: Refresh token не найден в базе данных
```json
{
  "detail": "Refresh token not found"
}
```

## Выход из системы

### Запрос
**Endpoint**: `POST /auth/logout`

**Заголовки**:
```
Authorization: Bearer <access_token>
```

**Тело запроса**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Успешный ответ
**Status**: `200 OK`

**Тело ответа**:
```json
{
  "message": "Successfully logged out"
}
```

### Ожидаемый результат
- Refresh token удаляется из базы данных
- Сессия становится неактивной
- Access token становится невалидным после истечения срока

### Ошибки
- **400 Bad Request**: При ошибках удаления токена
```json
{
  "detail": "Logout failed: [описание ошибки]"
}
```

## GitHub OAuth

### Инициация OAuth потока

**Endpoint**: `GET /auth/github`

**Действие**: Пользователь перенаправляется на страницу авторизации GitHub.

### Callback обработка

**Endpoint**: `GET /auth/github/callback`

**Параметры**: GitHub передает код авторизации через query parameters.

### Успешный ответ
**Status**: `200 OK`

**Тело ответа**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### Ожидаемый результат
1. Пользователь нажимает ссылку `/auth/github`
2. Перенаправление на GitHub для авторизации
3. После успешной авторизации GitHub перенаправляет на `/auth/github/callback`
4. Сервер обменивает код на access token GitHub
5. Получает информацию о пользователе из GitHub
6. Создает или находит пользователя в базе данных
7. Генерирует JWT токены для доступа к API
8. GitHub пользователи автоматически получают статус верифицированного автора

### Ошибки
- **400 Bad Request**: Ошибка аутентификации через GitHub
```json
{
  "detail": "OAuth authentication failed: [описание ошибки]"
}
```

- **400 Bad Request**: Email недоступен из GitHub
```json
{
  "detail": "Email not available from GitHub. Please make sure your email is public on GitHub."
}
```

## Управление сессиями

### Получение активных сессий

**Endpoint**: `GET /auth/sessions`

**Заголовки**:
```
Authorization: Bearer <access_token>
```

### Успешный ответ
**Status**: `200 OK`

**Тело ответа**:
```json
[
  {
    "id": 1,
    "user_agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36",
    "created_at": "2024-01-15T10:30:00",
    "expires_at": "2024-01-22T10:30:00"
  },
  {
    "id": 2,
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "created_at": "2024-01-16T14:20:00",
    "expires_at": "2024-01-23T14:20:00"
  }
]
```

### Ожидаемый результат
- Возвращается список всех активных refresh token сессий
- Каждая сессия содержит информацию о user agent и времени создания/истечения
- Пользователь может видеть, с каких устройств выполнен вход

### Ошибки
- **400 Bad Request**: Ошибка получения сессий
```json
{
  "detail": "Failed to get sessions: [описание ошибки]"
}
```

## Ролевая модель и права доступа

### Роли пользователей

#### 1. Обычный пользователь
- **Регистрация и аутентификация**
- **Просмотр** новостей и комментариев
- **Создание комментариев**
- **Редактирование и удаление** своих комментариев
- **НЕ может** создавать новости

#### 2. Верифицированный автор
- **Все права обычного пользователя**
- **Создание новостей**
- **Редактирование и удаление** своих новостей
- Статус назначается администратором

#### 3. Администратор
- **Все права верифицированного автора**
- **Просмотр списка** всех пользователей
- **Редактирование** любых пользователей
- **Назначение статусов** (верифицированный автор, администратор)
- **Удаление** любых пользователей
- **Редактирование и удаление** любых новостей и комментариев

### Права доступа

| Действие | Обычный | Автор | Админ |
|----------|---------|-------|-------|
| Просмотр новостей | ✅ | ✅ | ✅ |
| Создание комментариев | ✅ | ✅ | ✅ |
| Редактирование своих комментариев | ✅ | ✅ | ✅ |
| Удаление своих комментариев | ✅ | ✅ | ✅ |
| Создание новостей | ❌ | ✅ | ✅ |
| Редактирование своих новостей | ❌ | ✅ | ✅ |
| Удаление своих новостей | ❌ | ✅ | ✅ |
| Редактирование чужих новостей | ❌ | ❌ | ✅ |
| Удаление чужих новостей | ❌ | ❌ | ✅ |
| Просмотр списка пользователей | ❌ | ❌ | ✅ |
| Редактирование пользователей | ❌ | ❌ | ✅ |
| Назначение верификации | ❌ | ❌ | ✅ |
| Назначение администратора | ❌ | ❌ | ✅ |

### Примеры защищенных эндпоинтов

#### Создание новости (требуется верификация)
```bash
POST /news/
Headers: Authorization: Bearer <token>
Body: {
  "title": "Заголовок новости",
  "content": {"blocks": [{"type":"paragraph","text":"Текст новости"}]}
}
```

**Успешный ответ**:
```json
{
  "id": 1,
  "title": "Заголовок новости",
  "content": {"blocks": [{"type":"paragraph","text":"Текст новости"}]},
  "published_at": "2024-01-15T10:30:00",
  "author_id": 1,
  "cover": null
}
```

**Ошибка** (если пользователь не верифицирован):
```json
{
  "detail": "User is not verified to create news"
}
```

#### Удаление комментария (только автор или администратор)
```bash
DELETE /comments/1
Headers: Authorization: Bearer <token>
```

**Успешный ответ**:
```json
{
  "message": "Comment deleted successfully"
}
```

**Ошибка** (если пользователь не автор и не администратор):
```json
{
  "detail": "Not enough permissions to modify this comment"
}
```

## Ошибки аутентификации

### Общие ошибки

- **401 Unauthorized**: Неверный или отсутствующий access token
```json
{
  "detail": "Could not validate credentials"
}
```

- **403 Forbidden**: Недостаточно прав для выполнения действия
```json
{
  "detail": "Not enough permissions"
}
```

- **403 Forbidden**: Пользователь не верифицирован для создания новостей
```json
{
  "detail": "User is not verified to create news"
}
```

- **403 Forbidden**: Требуются права администратора
```json
{
  "detail": "Admin privileges required"
}
```

### Сроки действия токенов

- **Access Token**: 30 минут
- **Refresh Token**: 7 дней

### Рекомендации по безопасности

1. **Храните токены безопасно**: Не commit'ить в git, использовать environment variables
2. **Используйте HTTPS**: Все запросы должны быть зашифрованы
3. **Регулярно обновляйте токены**: Используйте refresh tokens для поддержания сессии
4. **Выходите из системы**: Всегда используйте logout для инвалидации refresh tokens
5. **Мониторьте активные сессии**: Регулярно проверяйте список активных сессий

### Пример полного цикла аутентификации

1. **Регистрация** → Получение токенов
2. **Создание новости** → Ошибка (не верифицирован)
3. **Админ верифицирует пользователя** → Обновление статуса
4. **Создание новости** → Успех
5. **Обновление токенов** → Новые токены
6. **Просмотр сессий** → Список активных устройств
7. **Выход из системы** → Инвалидация сессии

Эта документация охватывает все аспекты системы аутентификации и авторизации, включая примеры запросов, ответов и ожидаемого поведения системы.
